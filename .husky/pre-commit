#!/bin/sh

# Run type checking
echo "ğŸ” Running type check..."
npm run type-check || {
  echo "âŒ Type check failed. Please fix TypeScript errors before committing."
  exit 1
}

# Run linting
echo "ğŸ§¹ Running linter..."
npm run lint || {
  echo "âŒ Linting failed. Please fix linting errors before committing."
  exit 1
}

# Run tests for changed files (skip when no testable files staged)
echo "ğŸ§ª Running tests for changed files..."
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' || true)
if [ -n "$STAGED_FILES" ]; then
  npx jest --bail --findRelatedTests --passWithNoTests $STAGED_FILES || {
    echo "âŒ Tests failed. Following TDD, all tests must pass before committing."
    echo "ğŸ’¡ Tip: Write tests first (RED), then implementation (GREEN), then refactor."
    exit 1
  }
else
  echo "â„¹ï¸ No staged JS/TS files to test. Skipping related tests."
fi

# Check for .only or .skip in tests
echo "ğŸ” Checking for .only or .skip in tests..."
git diff --cached --name-only | xargs grep -l "\.only\|\.skip" | grep -E "\.(test|spec)\.(ts|tsx|js|jsx)$" && {
  echo "âŒ Found .only or .skip in test files. Please remove them before committing."
  exit 1
}

echo "âœ… All pre-commit checks passed!"
